<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ú‡∏•‡∏¥‡∏ï‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (‡∏™‡∏™‡∏à.)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f3f4f6;
        }
        .hidden-page {
            display: none;
        }
        .image-preview-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        .image-preview {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            background-color: #f0f0f0; /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏´‡∏•‡∏î */
        }
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            flex-direction: column;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-overlay">
        <i class="fa-solid fa-circle-notch fa-spin text-4xl text-teal-600 mb-3"></i>
        <p class="text-teal-800 font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        <p class="text-xs text-gray-500 mt-1">Google Sheets</p>
    </div>

    <!-- Navbar -->
    <nav class="bg-teal-700 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-clipboard-check text-xl"></i>
                <h1 class="text-lg font-bold">Food Surveyor</h1>
            </div>
            <div class="text-xs text-teal-200">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="max-w-md mx-auto p-4 pb-20">

        <!-- LIST VIEW: ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ -->
        <div id="listView">
            
            <!-- Search & Filters -->
            <div class="bg-white rounded-xl shadow-sm p-4 mb-4 space-y-3">
                <h2 class="text-gray-800 font-bold">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                
                <!-- Search Box -->
                <div class="flex gap-2">
                     <div class="relative flex-1">
                        <input type="text" id="searchInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô, ‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï..." 
                            class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 bg-gray-50 text-sm">
                        <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                    <button onclick="fetchVenues()" class="bg-gray-200 text-gray-600 px-3 rounded-lg hover:bg-gray-300">
                        <i class="fa-solid fa-rotate"></i>
                    </button>
                </div>

                <!-- Filters -->
                <div class="grid grid-cols-2 gap-2">
                    <!-- Amphoe Filter -->
                    <select id="amphoeFilter" onchange="applyFilters()" class="w-full p-2 border rounded-lg bg-gray-50 text-sm focus:ring-2 focus:ring-teal-500">
                        <option value="all">‡∏ó‡∏∏‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option>
                        <!-- Options generated by JS -->
                    </select>

                    <!-- Status Filter -->
                    <select id="statusFilter" onchange="applyFilters()" class="w-full p-2 border rounded-lg bg-gray-50 text-sm focus:ring-2 focus:ring-teal-500">
                        <option value="all">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                        <option value="pending">‚ö™ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</option>
                        <option value="done">üü¢ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß</option>
                    </select>
                </div>
                
                <!-- Summary Count -->
                <div class="flex justify-between text-xs text-gray-500 pt-1">
                    <span id="totalCount">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: 0</span>
                    <span id="doneCount" class="text-teal-600 font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß: 0</span>
                </div>
            </div>

            <!-- List Items -->
            <div id="venueList" class="space-y-3">
                <!-- Items injected here -->
            </div>
            
            <div id="emptyMessage" class="hidden-page mt-8 text-center text-gray-400 text-sm">
                -- ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç --
            </div>
        </div>

        <!-- FORM VIEW: ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà) -->
        <div id="formView" class="hidden-page">
            <button onclick="goBack()" class="mb-4 text-gray-500 hover:text-teal-700 flex items-center gap-2">
                <i class="fa-solid fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            </button>

            <!-- Read-only Info -->
            <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-teal-600 mb-4">
                <div class="flex justify-between items-start">
                    <h3 id="formName" class="text-xl font-bold text-gray-800">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô...</h3>
                    <span id="formStatusBadge" class="hidden-page text-xs font-bold px-2 py-1 rounded bg-green-100 text-green-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß</span>
                </div>
                
                <p class="text-sm text-gray-500 mt-1"><i class="fa-solid fa-id-card"></i> ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: <span id="formLicense" class="font-medium text-gray-700">...</span></p>
                <p class="text-sm text-gray-500 mt-1"><i class="fa-solid fa-user"></i> ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï: <span id="formOwner" class="font-medium text-gray-700">...</span></p>
                <p class="text-sm text-gray-500 mt-1"><i class="fa-solid fa-map"></i> ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠: <span id="formAmphoe" class="font-medium text-gray-700">...</span></p>
                <p class="text-sm text-gray-500 mt-1"><i class="fa-solid fa-map-marker-alt"></i> ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: <span id="formAddress" class="font-medium text-gray-700">...</span></p>
            </div>

            <!-- Survey Form -->
            <form id="surveyForm" class="bg-white rounded-xl shadow-sm p-5 space-y-6">
                
                <!-- 1. ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï/‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£</label>
                    <div class="grid grid-cols-3 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="status" value="active" class="peer sr-only" checked>
                            <div class="p-2 text-center border rounded-lg peer-checked:bg-green-100 peer-checked:border-green-500 peer-checked:text-green-700 text-sm transition">
                                <i class="fa-solid fa-check-circle block mb-1"></i> ‡∏¢‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="status" value="expired" class="peer sr-only">
                            <div class="p-2 text-center border rounded-lg peer-checked:bg-red-100 peer-checked:border-red-500 peer-checked:text-red-700 text-sm transition">
                                <i class="fa-solid fa-times-circle block mb-1"></i> ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏†‡∏≤‡∏û
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="status" value="unsure" class="peer sr-only">
                            <div class="p-2 text-center border rounded-lg peer-checked:bg-yellow-100 peer-checked:border-yellow-500 peer-checked:text-yellow-700 text-sm transition">
                                <i class="fa-solid fa-question-circle block mb-1"></i> ‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à
                            </div>
                        </label>
                    </div>
                </div>

                <!-- 2. ‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (GPS)</label>
                    <div class="flex gap-2">
                        <input type="text" id="gpsInput" readonly placeholder="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î" 
                            class="w-full px-3 py-2 bg-gray-100 border rounded-lg text-sm text-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="button" onclick="getLocation()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 active:scale-95 transition shrink-0">
                            <i class="fa-solid fa-location-crosshairs"></i>
                        </button>
                    </div>
                    <!-- GPS Help & Manual Input UI -->
                    <div id="gpsHelpText" class="hidden-page mt-2">
                        <div class="p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-800 mb-2">
                             <div class="font-bold mb-1"><i class="fa-solid fa-triangle-exclamation"></i> ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>
                             <p class="text-xs">‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Google Maps</p>
                        </div>
                        <a href="https://www.google.com/maps" target="_blank" 
                           class="block w-full text-center py-2 bg-white border border-gray-300 text-gray-700 rounded-lg text-sm hover:bg-gray-50">
                            <i class="fa-solid fa-map-location-dot text-red-500"></i> ‡πÄ‡∏õ‡∏¥‡∏î Google Maps
                        </a>
                    </div>
                </div>

                <!-- 3. ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">‡∏†‡∏≤‡∏û‡∏ñ‡πà‡∏≤‡∏¢‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏†‡∏≤‡∏û)</label>
                    
                    <input type="file" id="cameraInput" accept="image/*" capture="environment" multiple class="hidden" onchange="handleImageUpload(this)">
                    
                    <button type="button" onclick="document.getElementById('cameraInput').click()" 
                        class="w-full py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-teal-500 hover:text-teal-500 transition mb-3">
                        <i class="fa-solid fa-camera text-xl mb-1"></i><br>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà
                    </button>

                    <div id="imagePreviewContainer" class="grid grid-cols-3 gap-2">
                        <!-- Preview images will go here -->
                    </div>
                </div>

                <!-- 4. Note -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                    <textarea id="noteInput" rows="3" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£, ‡∏™‡∏∏‡∏Ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ..."></textarea>
                </div>

                <hr>

                <button type="submit" class="w-full bg-teal-700 text-white py-3 rounded-lg font-bold text-lg shadow-lg hover:bg-teal-800 active:scale-95 transition flex justify-center items-center gap-2">
                    <i class="fa-solid fa-paper-plane"></i> <span id="submitBtnText">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                </button>

            </form>
        </div>

    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg transition-opacity duration-300 opacity-0 pointer-events-none z-50">
        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢
    </div>

    <script>
        // *** CONFIGURATION ***
        // URL ‡∏Ç‡∏≠‡∏á Apps Script ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏° Deploy ‡πÉ‡∏´‡∏°‡πà‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ Code ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô)
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwBdAPL5wVRavuLPfJgmSmmr6yVKLN9R_lCABoUjVObxr5Xm9YDIRoPHm4zikIt4tfq/exec';

        // --- GLOBAL VARIABLES ---
        let allVenues = []; 
        let currentVenueId = null;
        let selectedImages = []; 

        // --- 1. INIT & FETCH DATA ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchVenues();
            document.getElementById('searchInput').addEventListener('keyup', applyFilters);
        });

        function fetchVenues() {
            const loading = document.getElementById('loadingScreen');
            loading.style.display = 'flex';

            // *** FIX CACHING ISSUE ***
            const urlWithCacheBuster = SCRIPT_URL + "?t=" + new Date().getTime();

            fetch(urlWithCacheBuster)
                .then(response => response.json())
                .then(data => {
                    allVenues = data;
                    setupAmphoeFilter(data); 
                    applyFilters();          
                    loading.style.display = 'none';
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    loading.innerHTML = `
                        <i class="fa-solid fa-exclamation-circle text-4xl text-red-500 mb-3"></i>
                        <p class="text-red-800 font-bold">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>
                        <p class="text-xs text-red-600 mt-2">‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á Deploy Script ‡πÉ‡∏´‡∏°‡πà</p>
                        <button onclick="location.reload()" class="mt-4 bg-teal-600 text-white px-4 py-2 rounded-lg">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
                    `;
                });
        }

        // --- 2. FILTER LOGIC ---
        function setupAmphoeFilter(data) {
            const amphoes = new Set(data.map(v => v.amphoe).filter(a => a)); 
            const select = document.getElementById('amphoeFilter');
            select.innerHTML = '<option value="all">‡∏ó‡∏∏‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option>';
            Array.from(amphoes).sort().forEach(amp => {
                const opt = document.createElement('option');
                opt.value = amp;
                opt.innerText = "‡∏≠. " + amp;
                select.appendChild(opt);
            });
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const amphoeVal = document.getElementById('amphoeFilter').value;
            const statusVal = document.getElementById('statusFilter').value;

            const filtered = allVenues.filter(v => {
                const matchText = (v.name && v.name.toLowerCase().includes(searchTerm)) || 
                                  (v.license && v.license.includes(searchTerm)) ||
                                  (v.owner && v.owner.toLowerCase().includes(searchTerm));
                
                const matchAmphoe = (amphoeVal === 'all') || (v.amphoe === amphoeVal);

                let matchStatus = true;
                if (statusVal === 'done') matchStatus = !!v.surveyData;
                if (statusVal === 'pending') matchStatus = !v.surveyData;

                return matchText && matchAmphoe && matchStatus;
            });

            document.getElementById('totalCount').innerText = `‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${filtered.length}`;
            const done = filtered.filter(v => v.surveyData).length;
            document.getElementById('doneCount').innerText = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß: ${done}`;

            renderList(filtered);
        }

        function renderList(data) {
            const list = document.getElementById('venueList');
            const emptyMsg = document.getElementById('emptyMessage');
            list.innerHTML = '';

            if(!data || data.length === 0) {
                emptyMsg.classList.remove('hidden-page');
                return;
            } else {
                emptyMsg.classList.add('hidden-page');
            }

            data.forEach(item => {
                const isDone = !!item.surveyData;
                const statusColor = isDone ? 'bg-green-50 border-green-200' : 'bg-white border-gray-100';
                const statusText = isDone ? '<span class="text-xs text-green-700 font-bold bg-green-200 px-2 py-0.5 rounded-full">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß</span>' : '<span class="text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">‡∏£‡∏≠‡∏™‡∏≥‡∏£‡∏ß‡∏à</span>';

                const card = document.createElement('div');
                card.className = `${statusColor} p-4 rounded-xl shadow-sm border active:scale-[0.99] transition cursor-pointer`;
                // ‡πÉ‡∏ä‡πâ String() ‡∏Ñ‡∏£‡∏≠‡∏ö id ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô string
                card.onclick = () => openForm(String(item.id));
                
                const locationText = item.amphoe ? `‡∏≠.${item.amphoe}` : (item.address || '-');

                card.innerHTML = `
                    <div class="flex justify-between items-start gap-2">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-bold text-gray-800 text-lg leading-tight">${item.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</h3>
                                ${statusText}
                            </div>
                            <p class="text-sm text-gray-600">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${item.license || '-'}</p>
                            <p class="text-xs text-gray-500 mt-1"><i class="fa-solid fa-location-dot"></i> ${locationText}</p>
                        </div>
                        <div class="flex items-center justify-center h-full pt-2">
                             <i class="fa-solid fa-chevron-right text-gray-300"></i>
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        // --- 3. FORM & EDIT LOGIC ---
        function openForm(id) {
            currentVenueId = String(id); // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô String ‡πÄ‡∏™‡∏°‡∏≠
            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏î‡∏¢‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà‡πÄ‡∏õ‡πá‡∏ô String ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå
            const venue = allVenues.find(v => String(v.id) === currentVenueId); 
            if (!venue) return;

            document.getElementById('formName').innerText = venue.name || '-';
            document.getElementById('formLicense').innerText = venue.license || '-';
            document.getElementById('formOwner').innerText = venue.owner || '-';
            document.getElementById('formAmphoe').innerText = venue.amphoe || '-';
            document.getElementById('formAddress').innerText = venue.address || '-';

            document.getElementById('surveyForm').reset();
            document.getElementById('imagePreviewContainer').innerHTML = '';
            selectedImages = [];
            resetGPSUI();

            if (venue.surveyData) {
                const sd = venue.surveyData;
                
                const statusRadio = document.querySelector(`input[name="status"][value="${sd.status}"]`);
                if (statusRadio) statusRadio.checked = true;

                document.getElementById('noteInput').value = sd.note || '';

                if (sd.gps) {
                    document.getElementById('gpsInput').value = sd.gps;
                }

                if (sd.images && sd.images.length > 0) {
                    sd.images.forEach(url => {
                        if(url) {
                            selectedImages.push(url); 
                            addImagePreview(url, true);
                        }
                    });
                }
                
                document.getElementById('submitBtnText').innerText = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
                document.getElementById('formStatusBadge').classList.remove('hidden-page');
            } else {
                document.getElementById('submitBtnText').innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
                document.getElementById('formStatusBadge').classList.add('hidden-page');
            }

            document.getElementById('listView').classList.add('hidden-page');
            document.getElementById('formView').classList.remove('hidden-page');
            window.scrollTo(0,0);
        }

        function resetGPSUI() {
            const gpsInput = document.getElementById('gpsInput');
            gpsInput.value = '';
            gpsInput.readOnly = true;
            gpsInput.classList.remove('bg-white', 'text-gray-800', 'text-red-600', 'border-red-300');
            gpsInput.classList.add('bg-gray-100', 'text-gray-600');
            document.getElementById('gpsHelpText').classList.add('hidden-page');
        }

        function goBack() {
            document.getElementById('formView').classList.add('hidden-page');
            document.getElementById('listView').classList.remove('hidden-page');
        }

        // --- 4. GPS & CAMERA ---
        function getLocation() {
            const gpsInput = document.getElementById('gpsInput');
            
            gpsInput.value = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...";
            gpsInput.readOnly = true;
            document.getElementById('gpsHelpText').classList.add('hidden-page');

            if (!navigator.geolocation) {
                enableManualGPS();
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    gpsInput.value = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
                    showToast("‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                },
                (err) => {
                    console.error("GPS Error", err);
                    enableManualGPS();
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
        }

        function enableManualGPS() {
            const gpsInput = document.getElementById('gpsInput');
            gpsInput.readOnly = false;
            gpsInput.value = "";
            gpsInput.placeholder = "‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Maps";
            gpsInput.classList.remove('bg-gray-100', 'text-gray-600');
            gpsInput.classList.add('bg-white', 'text-red-600', 'border-red-300');
            document.getElementById('gpsHelpText').classList.remove('hidden-page');
            alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß");
        }

        function handleImageUpload(input) {
            const files = Array.from(input.files);
            if (selectedImages.length + files.length > 3) {
                alert("‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏†‡∏≤‡∏û"); return;
            }
            files.forEach(file => {
                resizeImage(file, 800, 800, (base64) => {
                    selectedImages.push(base64);
                    addImagePreview(base64, false);
                });
            });
            input.value = ''; 
        }

        function resizeImage(file, mw, mh, cb) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    let w=img.width, h=img.height;
                    if(w>h){ if(w>mw){h*=mw/w; w=mw;}} else {if(h>mh){w*=mh/h; h=mh;}}
                    const cvs = document.createElement('canvas');
                    cvs.width = w; cvs.height = h;
                    cvs.getContext('2d').drawImage(img,0,0,w,h);
                    cb(cvs.toDataURL('image/jpeg', 0.7));
                }
            }
        }

        // *** FIX: Google Drive Image Display ***
        function addImagePreview(src, isUrl) {
            const container = document.getElementById('imagePreviewContainer');
            
            // Logic: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á Google Drive ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö Direct Link
            let displaySrc = src;
            if (isUrl && src.includes('drive.google.com')) {
                // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á File ID ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤
                // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥: https://drive.google.com/file/d/FILE_ID/view...
                // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: https://drive.google.com/thumbnail?id=FILE_ID&sz=w800
                const match = src.match(/\/d\/(.+?)\/|id=(.+?)(&|$)/);
                if (match) {
                    const id = match[1] || match[2];
                    // ‡πÉ‡∏ä‡πâ thumbnail endpoint ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏ô‡∏≤‡∏î w800 ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏Å‡∏ß‡πà‡∏≤ uc?export=view
                    displaySrc = `https://drive.google.com/thumbnail?id=${id}&sz=w800`;
                }
            }

            const div = document.createElement('div');
            div.className = 'image-preview-wrapper';
            const borderClass = isUrl ? 'border-blue-200' : 'border-gray-200';

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° referrerpolicy="no-referrer" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£ block
            div.innerHTML = `
                <img src="${displaySrc}" class="image-preview border-2 ${borderClass}" 
                     referrerpolicy="no-referrer"
                     onerror="this.src='https://via.placeholder.com/150?text=Error';this.onerror=null;">
                <button type="button" onclick="removeImage(this, '${src}')" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs shadow-md z-10">
                    <i class="fa-solid fa-times"></i>
                </button>
            `;
            container.appendChild(div);
        }

        function removeImage(btn, src) {
            btn.parentElement.remove();
            selectedImages = selectedImages.filter(img => img !== src);
        }

        // --- 5. SUBMIT ---
        document.getElementById('surveyForm').addEventListener('submit', function(e) {
            e.preventDefault();

            // ‡∏™‡πà‡∏á ID ‡πÄ‡∏õ‡πá‡∏ô String ‡πÄ‡∏™‡∏°‡∏≠
            const formData = {
                venueId: String(currentVenueId),
                status: document.querySelector('input[name="status"]:checked').value,
                gps: document.getElementById('gpsInput').value,
                note: document.getElementById('noteInput').value,
                images: selectedImages, 
                timestamp: new Date().toISOString()
            };

            const btn = this.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(formData)
            })
            .then(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                
                // Update Local Data using String comparison
                const venue = allVenues.find(v => String(v.id) === String(currentVenueId));
                if(venue) {
                    venue.surveyData = {
                        status: formData.status,
                        gps: formData.gps,
                        note: formData.note,
                        images: formData.images
                    };
                }
                
                setTimeout(() => { 
                    goBack(); 
                    applyFilters(); 
                }, 1000);
            })
            .catch(err => {
                console.error(err);
                btn.innerHTML = originalText;
                btn.disabled = false;
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
            });
        });

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('opacity-0');
            setTimeout(() => t.classList.add('opacity-0'), 3000);
        }
    </script>
</body>
</html>
